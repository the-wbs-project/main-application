@if (entryStore.viewModels(); as tree) { @if (alert(); as alertText) {
<wbs-alert
  type="danger"
  [message]="alertText"
  (closed)="alert.set(undefined)"
/>
} @else {
<wbs-alert
  type="info"
  [dismissible]="false"
  message="Projects.TreeInstructions"
/>
}
<kendo-treelist
  #treelist
  class="tx-12"
  kendoTreeListExpandable
  kendoTreeListSelectable
  [kendoTreeListFlatBinding]="tree"
  parentIdField="treeParentId"
  idField="treeId"
  [rowReorderable]="true"
  [initiallyExpanded]="false"
  [(expandedKeys)]="treeService.expandedKeys"
  [navigable]="true"
  [selectable]="{ enabled: true, mode: 'row' }"
  [rowReorderable]="canEdit()"
  (selectionChange)="selectedTask.set($event.items[0].dataItem)"
  (rowReorder)="rowReordered($event)"
  (cellClick)="cellClick($event)"
  (dblclick)="navigateToTask(selectedTask()?.id)"
>
  <ng-template kendoTreeListToolbarTemplate>
    @if (canCreate()) {
    <wbs-tree-buttons-add (click)="menuItemSelected('addSub')" />
    }
    <wbs-tree-buttons-toggler
      (collapse)="treeService.collapseAll(treelist, tree)"
      (expand)="treeService.expandAll(treelist, tree)"
    />
  </ng-template>
  @if (canEdit()) {
  <kendo-treelist-rowreorder-column [width]="40" />
  }
  <kendo-treelist-column
    field="levelText"
    [title]="'Wbs.Level' | translate"
    [width]="treeService.levelsWidth(tree)"
    class="tree-column"
    headerClass="tx-14"
  />
  <kendo-treelist-column
    [expandable]="true"
    field="title"
    class="child-hoverer tree-column"
    headerClass="tx-14"
    [title]="'Wbs.Activity_Title' | translate"
  >
    <ng-template kendoTreeListCellTemplate let-dataItem>
      @defer (on idle) {
      <wbs-task-title
        [title]="dataItem.title"
        [canEdit]="canEdit()"
        (titleChange)="taskTitleChanged(dataItem.id, $event)"
      />
      @if (taskSaveStates.get(dataItem.id); as saveState) {
      <wbs-save-message [state]="saveState()" cssClass=" mg-l-15 tx-12" />
      } } @placeholder {
      <span class="tx-8">Loading...</span>
      }
    </ng-template>
  </kendo-treelist-column>
  <kendo-treelist-column [width]="100" class="tree-column" headerClass="tx-14">
    <ng-template kendoTreeListHeaderTemplate>
      <wbs-tree-flag-column-header />
    </ng-template>
    <ng-template kendoTreeListCellTemplate let-dataItem>
      @if (dataItem.visibility) { @defer (on idle) {
      <wbs-visibility-icon [visibility]="dataItem.visibility" />
      } @placeholder {
      <span class="tx-8"> {{ "General.Loading" | translate }}...</span>
      } }
    </ng-template>
  </kendo-treelist-column>
  @if ((width() ?? 0) > 800) {
  <kendo-treelist-column
    [width]="treeService.disciplineWidth(tree)"
    class="tree-column"
    headerClass="tx-14"
  >
    <ng-template kendoTreeListHeaderTemplate>
      @defer (on idle) {
      <wbs-tree-discipline-legend [list]="disciplines()" />
      } @placeholder {
      <span class="tx-8">{{ "General.Loading" | translate }}...</span>
      }
    </ng-template>
    <ng-template kendoTreeListCellTemplate let-dataItem>
      @if ((dataItem.disciplines ?? []).length > 0) { @defer (on idle) {
      <wbs-discipline-icon-list [items]="dataItem.disciplines" />
      } @placeholder {
      <span class="tx-8"> {{ "General.Loading" | translate }}...</span>
      } }
    </ng-template>
  </kendo-treelist-column>
  }
</kendo-treelist>
@defer (on idle) {
<kendo-contextmenu
  #contextMenu
  [items]="menu()"
  (select)="menuItemSelected($event.item.action)"
>
  <ng-template kendoMenuItemTemplate let-item="item">
    <wbs-context-menu-item [item]="item" />
  </ng-template>
</kendo-contextmenu>
} }
