# Node.js with Angular
# Build a Node.js project that uses Angular.
# Add steps that analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/javascript

trigger:
  - main

pool:
  vmImage: ubuntu-latest

jobs:
  - job: worker_job
    displayName: Worker
    steps:
      - task: NodeTool@0
        inputs:
          versionSpec: "18.10"
        displayName: "Install Node.js"

      - script: |
          yarn global add esbuild
        displayName: "Install ES Build"

      - script: yarn
        workingDirectory: "worker"
        displayName: "Install Worker Packages"

      - script: yarn run build
        workingDirectory: "worker"
        displayName: "Build Worker"

      - task: ArchiveFiles@2
        inputs:
          rootFolderOrFile: 'worker'
          includeRootFolder: false
          archiveType: 'zip'
          archiveFile: '$(Build.ArtifactStagingDirectory)/$(Build.BuildId)-Worker.zip'
          replaceExistingArchive: true
        displayName: "Zip Worker"

  - job: site_setup_job
    displayName: Site Setup
    dependsOn: worker_job
    steps:
      - script: |
          echo "$(FA_LICENSE)"
          npm config set "@fortawesome:registry" https://npm.fontawesome.com/ && npm config set "//npm.fontawesome.com/:_authToken" $(FA_LICENSE)
        workingDirectory: "site"
        env:
          FA_LICENSE: $(FA_LICENSE)
        displayName: "Setup Font Awesome Registry"
      - script: yarn global add @angular/cli
        displayName: "Install Angular CLI"

      - script: yarn
        workingDirectory: "site"
        displayName: "Install Site Packages"

      - script: npx kendo-ui-license activate
        workingDirectory: "site"
        env:
          KENDO_UI_LICENSE: $(KENDO_UI_LICENSE)
        displayName: "Setup Kendo UI License"

  - job: site_qa_job
    displayName: Site - QA
    dependsOn: site_setup_job
    steps:
      - script: yarn run deploy:qa
        workingDirectory: "site"
        displayName: "Build"

      - task: ArchiveFiles@2
        inputs:
          rootFolderOrFile: 'dist'
          includeRootFolder: false
          archiveType: 'zip'
          archiveFile: '$(Build.ArtifactStagingDirectory)/$(Build.BuildId)-QA.zip'
          replaceExistingArchive: true
        displayName: "Zip"

  - job: site_prod_job
    displayName: Site - Prod
    dependsOn: site_qa_job
    steps:
      - script: yarn run deploy:prod
        workingDirectory: "site"
        displayName: "Build"

      - task: ArchiveFiles@2
        inputs:
          rootFolderOrFile: 'dist'
          includeRootFolder: false
          archiveType: 'zip'
          archiveFile: '$(Build.ArtifactStagingDirectory)/$(Build.BuildId)-Prod.zip'
          replaceExistingArchive: true
        displayName: "Zip Production"

  - job: publish_job
    displayName: Publish
    dependsOn: site_prod_job
    steps:
        
      - task: PublishBuildArtifacts@1
        inputs:
          PathtoPublish: '$(Build.ArtifactStagingDirectory)'
          ArtifactName: 'drop'
          publishLocation: 'Container'
        displayName: "Publish"